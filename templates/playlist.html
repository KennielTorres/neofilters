{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/playlist.css')}}">
<script type="text/javascript" src="{{ url_for('static', filename='js/playlist.js') }}"></script>
<script>
    jQuery(document).ready(function($){

        var content_container_height = $(window).height() -  $('#playlist-header').outerHeight()
        $('#content-container').css('height', content_container_height + 'px');

        // Live search functionality
        $('#tracks-container > .track-card').each(function(){
            $(this).attr('data-search-terms', $(this).find('.track_name, .artists').text().trim().replace(/\s\s+/g, ' ').toLowerCase());
            // $(this).attr('data-isrc', $(this).find('#isrc').text().substring(6))
        });
        
        // Name or artist search
        $('#header-input').on('keyup', function(){
            var searchTerm = $(this).val().trim().toLowerCase();
            $('#tracks-container > .track-card').each(function(){
                if ($(this).filter('[data-search-terms*="' + searchTerm + '"]').length > 0 || searchTerm.length < 1) {
                    $(this).show();
                } 
                else {
                    $(this).hide();
                }
            });
        });
    });

    function structureFormAction(){
        let form = document.getElementById('sort_-orm')
        let select = document.getElementById('sort-select')
        let selectedOption = select.options[select.selectedIndex].value
        let currentUrl = window.location.href.split('?')[0]
        let updatedUrl = currentUrl + '?sort-by=' + selectedOption
        form.action = updatedUrl
        form.submit()
    };

</script>
{% endblock %}


{% block body %}
<div id="body-container">
    <header id="playlist-header">
        <a id="return-arrow" href="{{ url_for('menu') }}"><img src="{{ url_for('static', filename='icons/return_arrow.svg')}}" title="Return"></a>
        <div id="header-left">
            <p id="playlist-name" class="header-left-item">{{ playlist_details.get('name')|default('Playlist',true)|truncate(25, True) }}</p>
            <input class="header-left-item" id="header-input" type="text" placeholder="Name or Artists" maxlength="30">
        </div>
        <a id="sign-out-btn" class="pointer" title='Sign Out of Spotify.' onclick="window.location = window.location.origin.concat('/signout')">Sign Out</a>
    </header>

    <div id="content-container">
        <div id="filters-container">
            <div id="filter-header">
                <input id="filter-toggle" type="checkbox">
                <label id="toggle-arrow" for="filter-toggle" style="text-align: center;"><img id="toggle-arrow-img" src="{{ url_for('static', filename='icons/arrow_toggler.svg')}}"></label>
                <p>Menu</p>
            </div>
            <div id="options-parent">
                <div id="filtering_options">
                    <div id="option-1" class="flex flex-row space-evenly align-items-c">
                        <input id="explicit" type="checkbox">
                        <label for="explicit">Explicit</label>
                        <input id="clean" type="checkbox">
                        <label for="clean">Clean</label>
                    </div>
                    <div id="option-2" class="flex flex-col align-items-c">
                        <label for="search">Search</label>
                        <input id="search" type="text" maxlength="30" placeholder="ISRC">
                    </div>
                    <div id="option-3">
                        <p>Release Date</p>
                        <div class="flex flex-col align-items-c">
                            <label >From</label>
                            <input id="rel-lower-bound" type="date">
                        </div>
                        <div class="flex flex-col align-items-c">
                            <label >To</label>
                            <input id="rel-upper-bound" type="date">
                        </div>
                    </div>
                    <div id="option-4">
                        <p>Added Date</p>
                        <div class="flex flex-col align-items-c">
                            <label >From</label>
                            <input id="add-lower-bound" type="date">
                        </div>
                        <div class="flex flex-col align-items-c">
                            <label >To</label>
                            <input id="add-upper-bound" type="date">
                        </div>
                    </div>
                    <div id="sorting-options" class="flex flex-col align-items-c">
                        <label for="sort-form" >Sort By</label>
                        <form action="{{ request.path }}" method="post" id="sort-form">
                            <select name="sort-select" id="sort-select" onchange="structureFormAction()">
                                <option value="none" selected>Select</option>
                                <option value="default">Default</option>
                                <option value="alph-asc">A-Z</option>
                                <option value="alph-desc">Z-A</option>
                                <option value="most-popular">Most Popular First</option>
                                <option value="least-popular">Least Popular First</option>
                                <option value="rel-asc">Release Date Ascending</option>
                                <option value="rel-desc">Release Date Descending</option>
                                <option value="added-asc">Added Date Ascending</option>
                                <option value="added-desc">Added Date Descending</option>
                            </select>
                        </form>
                    </div>
                </div>
                
            </div>
        </div>
        <div id="tracks-container">
            {% for track in tracks %}
            <div class="track-card" 
                    data-id="{{ loop.index }}"
                    data-explicit="{{ track.get('track').get('explicit') }}"
                    >
                <div class="card-block-1">
                    {% if track.get('track').get('album').get('images')|length > 0 %}
                        <img class="artwork" src="{{ track.get('track').get('album').get('images')[0].get('url') }}">
                    {% else %}
                        <img class="artwork" src="../static/icons/black_square.svg">
                    {% endif %}
                    <div class="c-b-1-row">
                        <p class="duration c-b-1-row-item">{{ track.get('track').get('duration_ms') }}</p>
                        {% if track.get('track').get('explicit') %}
                            <img id="rating" src="../static/icons/explicit_track.svg" class="c-b-1-row-item">
                        {% endif %}
                    </div>
                </div>
                <div class="card-block-2">
                    <p class="track_name"><a href="{{ track.get('track').get('external_urls').get('spotify') }}" target="_blank" rel="noopener noreferrer">{{ track.get('track').get('name') }}</a></p>
                    <p class="rel_date" title="In ISO 8601 format.">Released: {{ track.get('track').get('album').get('release_date') }}</p>
                    <p class="added_date" title="In ISO 8601 format.">Added: {{ track.get('added_at')[:10] }}</p>
                </div>
                <div class="card-block-3">
                    <div class="artists">
                        {% for artist in track.get('track').get('artists') %}
                            <p class="artist-{{ loop.index }}"><a href="{{ artist.get('external_urls').get('spotify') }}" target="_blank" rel="noopener noreferrer">{{ artist.get('name') }}</a></p>
                        {% endfor %}
                    </div>
                    <p class="isrc">ISRC: {{ track.get('track').get('external_ids').get('isrc') }}</p>
                    <p class="popularity">Popularity: {{ track.get('track').get('popularity') }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>


    
</div>




{% endblock %}
