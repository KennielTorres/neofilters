{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="../static/styles/playlist.css">
<script>
    jQuery(document).ready(function($){
        var explicitTracks = $("[data-explicit='True']")
        var cleanTracks = $("[data-explicit='False']")

        // Store the original order of the track cards
        var originalTrackOrder = []; 
        // originalTrackOrder.push($("#track-wrapper").children())
        $('#track-wrapper > #track-card').each(function() {
            originalTrackOrder.push($(this))
        });
        console.log("og order", originalTrackOrder)
        // UNTIL ABOVE IT WORKS

        // Function to reset the track cards to the original order. NEEDS SOME TWEAKING, NOT DOING ANYTHING<><><><>
        function resetTrackCards() {
            $("#track-wrapper").empty()
            $("#track-wrapper").append(originalTrackOrder)
        };

        // Function to sort the track cards
        function sortTrackCards(sortingOption) {
            var trackCards = $("#track-wrapper").children()
            console.log("trackCards", trackCards)
            
            trackCards.sort(function(a, b) {
                var trackNameA = $(a).find("#track_name").text().toUpperCase()
                var trackNameB = $(b).find("#track_name").text().toUpperCase()

                if (sortingOption == "ascending") {
                    return (trackNameA < trackNameB) ? -1 : (trackNameA > trackNameB) ? 1 : 0;
                } else if (sortingOption == "descending") {
                    return (trackNameA > trackNameB) ? -1 : (trackNameA < trackNameB) ? 1 : 0;
                } else {
                    // If sortingOption is "None" or any other invalid value, reset the track cards
                    resetTrackCards(); // PROBLEM IS HEREEEEEEE<><><><><>
                    return 0;
                }
            })

            $("#track-wrapper").empty();
            console.log("sort function post-empty", $("#track-wrapper"))
            $("#track-wrapper").append(trackCards);
        };
        
        // Performs the sorting based on option selected
        $("select[name='sorting_options']").on("change", function() {
            var sortingOption = $(this).val();
            sortTrackCards(sortingOption);
        });

        // Shows or hides filtering containers based on selection
        $('#filter_options').change(function() {
            var selected = $(this).val()

            if (selected == 'added_date' || selected == 'rel_date'){
                $('#date_container').show()
                $('#duration_container').hide()
            }
            else if (selected == 'duration'){
                $('#date_container').hide()
                $('#duration_container').show()
            }
            else if (selected == 'explicit'){
                $('#date_container').hide()
                $('#duration_container').hide()
                
                $('#track-wrapper > #track-card').each(function(){
                    explicitTracks.show()
                    cleanTracks.hide()
                })
            }
            else if (selected == 'clean'){
                $('#date_container').hide()
                $('#duration_container').hide()
                
                $('#track-wrapper > #track-card').each(function(){
                    cleanTracks.show()
                    explicitTracks.hide()
                })
            } 
            else {
                $('#date_container').hide()
                $('#duration_container').hide()
                explicitTracks.show()
                cleanTracks.show()
            }
        });

        // Live search functionality
        $('#track-wrapper > #track-card').each(function(){
            $(this).attr('data-search-terms', $(this).find('#track_name, #artists').text().trim().replace(/\s\s+/g, ' ').toLowerCase());
        });

        $('#live-search-input').on('keyup', function(){
            var searchTerm = $(this).val().trim().toLowerCase();
            $('#track-wrapper > #track-card').each(function(){
                if ($(this).filter('[data-search-terms*="' + searchTerm + '"]').length > 0 || searchTerm.length < 1) {
                    $(this).show();
                } 
                else {
                    $(this).hide();
                }
            });
        });


    });
</script>
{% endblock %}

{% block navclasses %} justify-space-between margin-sides-1 {% endblock%}
{% block nav %}
    <a href="{{ url_for('dashboard') }}" class="no-text-decor color-inherit">spotifilters</a>
    {% include 'signout_btn.html' %}
{% endblock %}

{% block content %}
<div id="playlist_container">
    <header id="playlist_cont_header" class="pos-sticky top-0 bg-lightblue flex justify-space-between padding-sides-1">
        <h1>{{ playlist_details.get('name')|default('Playlist',true) }}</h1>
        <h2> 
            {% if playlist_details.get('public') %}
                Public
            {% else %}
                Private
            {% endif %}
        </h2> 
    </header>
    <div class="margin-sides-1 flex justify-space-between">
        <div>
            <label for="#live-search-input">Search</label>
            <input id="live-search-input" type="text" name="track_search" placeholder="Name or Artist/s" maxlength="40">
        </div>
        <div id="main_options_wrapper" class="flex">
            <div id="filtering_container">
                <label for="filter_options">Filter:</label>
                <select name="filter_options" id="filter_options">
                    <option selected value="None">None</option>
                    <optgroup label="Range">
                        <option value="added_date">Added Date</option>
                        <option value="rel_date">Release Date</option>
                        <option value="duration">Duration</option>
                    </optgroup>
                    <optgroup label="Rating">
                        <option value="explicit">Explicit</option>
                        <option value="clean">Clean</option>
                    </optgroup>
                    <optgroup label="Extra">
                        <option value="isrc">ISRC</option>
                        <option value="popularity">Popularity</option>
                    </optgroup>
                </select>
            </div>

            <div id="sorting_container">
                <label for="sorting_options">Sort:</label>
                <select name="sorting_options">
                    <option selected value="None">None</option>
                    <option value="ascending">Ascending</option>
                    <option value="descending">Descending</option>
                </select>
            </div>
        </div>
    </div>

    <div class="flex justify-end w-100 bg-medblue">
        <div id="date_container" class="hide">
            <label for="date_inputs">Date</label>
            <div id="date_inputs" class="inline-flex flex-wrap">
                <p>From:</p>
                <input type="date" id="date_selector_lower_bound">
                <p>To:</p>
                <input type="date" id="date_selector_upper_bound">
            </div>
        </div>

        <div id="duration_container" class="hide">
            <label for="duration_select_lower_bound">Duration</label>
            <div id="duration_inputs" class="inline-flex flex-wrap">
                <p>From:</p>
                <input type="number" value="0" min="0" max="59" id="duration_select">
                <p>minutes</p>
                <p>To:</p>
                <input type="number" value="1" min="1" max="60" id="duration_select">
                <p>minutes</p>
            </div>
        </div>
    </div>

    <main id="track-wrapper">
        {% for track in tracks %}
        <div id="track-card" 
                data-id="{{ loop.index }}"
                data-explicit="{{ track.get('track').get('explicit') }}"
                >
            <table id="track-card-table" class="bg-lightblue margin-sides-1 align-items-center">
                <col id="col1"/>
                <col id="col2"/>
                <col id="col3"/>
                <col id="col4"/>
                <tr>
                    <td colspan="2" rowspan="2">
                        {% if track.get('track').get('album').get('images')|length > 0 %}
                            <img class="picture-1" id="art" src="{{ track.get('track').get('album').get('images')[0].get('url') }}">
                        {% else %}
                            <img class="picture-1" id="art" src="../static/icons/black_square.svg">
                        {% endif %}
                    </td>
                    <td>
                        <h1 id="track_name"><a href="{{ track.get('track').get('external_urls').get('spotify') }}" target="_blank" rel="noopener noreferrer">{{ track.get('track').get('name') }}</a></h1>
                    </td>
                    <td>
                        <div id="artists">
                            {% for artist in track.get('track').get('artists') %}
                                <h2 id="artist-{{ loop.index }}"><a href="{{ artist.get('external_urls').get('spotify') }}" target="_blank" rel="noopener noreferrer">{{ artist.get('name') }}</a></h2>
                            {% endfor %}
                        </div>
                    </td>
                </tr>
    
                <tr>
                    <td>
                        <p id="rel_date" title="In ISO 8601 format.">Released: {{ track.get('track').get('album').get('release_date') }}</p>
                    </td>
                    <td>
                        <p id="isrc">ISRC: {{ track.get('track').get('external_ids').get('isrc') }}</p>
                    </td>
                </tr>
    
                <tr>
                    <td>
                        <p id="duration" class="text-center">{{ track.get('track').get('duration_ms') }}</p>
                    </td>
                    <td>
                        <div id="rating" class="text-center">
                            {% if track.get('track').get('explicit') %}
                                <img src="../static/icons/explicit_track.svg">
                            {% endif %}
                        </div> 
                    </td>
                    <td>
                        <p id="added_date" title="In ISO 8601 format.">Added: {{ track.get('added_at')[:10] }}</p>
                    </td>
                    <td>
                        <p id="popularity">Popularity: {{ track.get('track').get('popularity') }}</p>
                    </td>
                </tr>
                
            </table>
        </div>
        {% endfor %}
    </main>

</div>




{% endblock %}
